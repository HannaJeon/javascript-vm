<!DOCTYPE html>
<html lang="ko">
<head>
    <title>Luigi's vending machine</title>
    <link rel="stylesheet" type="text/css" href="./main.css">
    <script>
        document.addEventListener("DOMContentLoaded", function(event) {
            var item_panel = {
                li : document.querySelectorAll(".item_panel li"),
                highLighting :  function(){ //highLighting()
                    var list = document.querySelectorAll(".item_panel li");
                    var money_insert = parseInt(document.querySelector(".money_insert").value);
                    
                    list.forEach(function(value){
                        var cost = parseInt(value.children[1].children[1].innerText);
                        if (money_insert >= cost) {
                            value.classList.add("yellow");
                        }
                        else value.classList.remove("yellow");
                    });

                },
                buyable : function(money_insert,index){
                    //없는번호 , 잔액 부족 , 구매가능  -> 잔액부족은 class(yello)보고 판단할까..
                    if(this.li.length < index || index <= 0){
                        return "없는번호\n";
                    }
                    else if(this.li[index-1].className !== "yellow"){
                        //var cost = this.li[index-1].children[1].children[1].innerText;
                        //money_insert >= cost ? result = "enable" : result = "disable"
                        return "잔액부족\n";
                    }
                    else return "구매가능\n";
                }
            }

            var select_panel = {
                timer : null,
                button_clicked  : document.querySelector(".button_clicked"),
                money_insert : document.querySelector(".money_insert"),
                event : function(){ //setSelectNumber()
                    document.querySelector(".select_button").addEventListener("click",function(e){
                        if(e.target && e.target.nodeName == "BUTTON"){
                            this.button_clicked.value += e.target.innerText;
                            clearTimeout(this.timer);
                            this.timer = setTimeout(this.executeSelection.bind(this,this.button_clicked.value),3000);
                        }
                    }.bind(this)); //timer에 대한 접근을 위해 bind
                },
                 statusLogChanger : function(arg){ 
                    var statusLog = document.querySelector(".status_log");
                    statusLog.value += arg;
                    
                    if (statusLog.selectionStart == statusLog.selectionEnd) {
                        statusLog.scrollTop = statusLog.scrollHeight;
                    }
                },

                executeSelection : function(index){
                    //console.log(item_panel.buyable(this.money_insert.value,index)); //없는번호 , 잔액부족 , 구매가능
                    var flag = item_panel.buyable(this.money_insert.value,index);
                    if(document.querySelector(".button_clicked").value == ""){
                        console.log("반환");
                    }
                    else {
                        // if(flag == "없는번호"){
                        //     this.statusLogChanger(flag);
                        // }
                        // else if(flag == "잔액부족"){
                        //     this.statusLogChanger(flag);
                        // }
                        // else this.statusLogChanger(flag);
                        // console.log("계산!");
                        this.statusLogChanger(flag);
                        document.querySelector(".button_clicked").value = "";
                        //타이머 3초
                    }
                    
                }
                
            }

            var money_panel = {
                money_button : document.querySelector(".money_button").children,
                temp : document.querySelector(".money_have").value,
                run : function() {
                    this.reset();
                    this.input();
                    document.querySelector(".refreshWallet").addEventListener("click",this.refreshWallet);
                },
                reset : function(){ //refreshWallet()
                    for(var i = this.money_button.length-1;i>=0;i--){
                        var container = this.money_button[i];
                        var button = container.children[0];
                        var span = container.children[1];
                        var spanData = span.dataset; //value를 저장하면 단순 값 복사가 되버림
                        spanData.value = Math.floor(this.temp/container.dataset.value); 
                        
                        if(spanData.value == 0){
                            button.disabled = true;
                        }
                        else{
                            button.disabled = false;
                        }
        
                        span.innerText = spanData.value + "개";
                        this.temp = this.temp % container.dataset.value;
                    }
                },
                input : function(){ //clickMoneyButton(){ 
                    var money_insert = document.querySelector(".money_insert");
                    var money_have = document.querySelector(".money_have");
            
                    document.querySelector(".money_button").addEventListener("click",function(e){
                        if (e.target && e.target.nodeName == "BUTTON"){
                            select_panel.statusLogChanger(e.target.innerText+"이 투입됨\n");
                            setHaveMoney(-e.target.parentNode.dataset.value);
                            setInsertMoney(e.target.parentNode.dataset.value);
                            this.refreshWallet();
                            item_panel.highLighting();
                        }
                    }.bind(this)); //refreshWallet에 대한 접근을 위한 bind
                },
                refreshWallet : function(){
                    var money_button = document.querySelector(".money_button").children;
                    var temp = document.querySelector(".money_have").value;
                    for(var i = money_button.length-1;i>=0;i--){
                        var container = money_button[i];
                        var button = container.children[0];
                        var span = container.children[1];
                        var spanData = span.dataset; //value를 저장하면 단순 값 복사가 되버림
                        spanData.value = Math.floor(temp/container.dataset.value); 
                        
                        if(spanData.value == 0){
                            button.disabled = true;
                        }
                        else{
                            button.disabled = false;
                        }

                        span.innerText = spanData.value + "개";
                        temp = temp % container.dataset.value;
                    }
                }
            }        
            console.log("DOM fully loaded and parsed");
            money_panel.run(); //money_panel.reset(); money_panel.input();
            select_panel.event();
        });
        
        function executeSelection(){
            document.querySelector(".button_clicked").value = "";
        }

        /*
        function refreshWallet(){ //getMoneyButton -> refreshWallet
            var money_button = document.querySelector(".money_button").children;
            var temp = document.querySelector(".money_have").value;
            for(var i = money_button.length-1;i>=0;i--){
                var container = money_button[i];
                var button = container.children[0];
                var span = container.children[1];
                var spanData = span.dataset; //value를 저장하면 단순 값 복사가 되버림
                spanData.value = Math.floor(temp/container.dataset.value); 
                
                if(spanData.value == 0){
                    button.disabled = true;
                }
                else{
                    button.disabled = false;
                }

                span.innerText = spanData.value + "개";
                temp = temp % container.dataset.value;
            }
        }
        */

        //구매를 위한 숫자입력 이벤트
        //버튼클릭 -> 3초타임아웃 -> 입력된 숫자들에 대해서 처리
        //잘못된 번호 -> 잘못된 입력 -> 3초타임아웃
        //올바른 번호 && 잔액 < 물품가격 -> 잔액이 부족합니다 -> 3초타임아웃
        //올바른 번호 && 잔액 >= 물품가격 (else 조건) -> x번 y가 선택됨 -> 3초타임아웃
        //3초타임아웃이후 버튼입력 x -> 잔돈 x원 반환
        /*
        function setSelectNumber(){
            document.querySelector(".select_button").addEventListener("click",function(e){
                if(e.target && e.target.nodeName == "BUTTON"){
                    document.querySelector(".button_clicked").value += e.target.innerText;
                    clearTimeout(timer);
                    timer = setTimeout(executeSelection,3000);
                }
            });
        }
        */

        /*
        function clickMoneyButton(){ 
            var money_insert = document.querySelector(".money_insert");
            var money_have = document.querySelector(".money_have");
            
            document.querySelector(".money_button").addEventListener("click",function(e){
                if (e.target && e.target.nodeName == "BUTTON"){
                    statusLogChanger(e.target.innerText+"이 투입됨\n");
                    setHaveMoney(-e.target.parentNode.dataset.value);
                    setInsertMoney(e.target.parentNode.dataset.value);
                    refreshWallet();
                    highLighting();
                }
            });
        }
        */

        function setInsertMoney(arg){
            var money_insert = document.querySelector(".money_insert");
            money_insert.value = parseInt(money_insert.value) + parseInt(arg);
        }
        function setHaveMoney(arg){
            var money_have = document.querySelector(".money_have");
            money_have.value = parseInt(money_have.value) + parseInt(arg);
        }

        /*
        function statusLogChanger(arg){ 
            var statusLog = document.querySelector(".status_log");
            statusLog.value += arg;
            
            if (statusLog.selectionStart == statusLog.selectionEnd) {
                statusLog.scrollTop = statusLog.scrollHeight;
            }
        }
        */

        /*
        function highLighting(){ 
            //element.classList.add(classname); remove(className);
            //element.className = className;
            var list = document.querySelectorAll(".item_panel li");
            var money_insert = parseInt(document.querySelector(".money_insert").value);
            //물품가격 list[i].children[1].children[1].innerText //dataset으로 li에 주는게 좋을까?;;
            list.forEach(function(value){
                var cost = parseInt(value.children[1].children[1].innerText);
                console.log(cost,money_insert);
                if (money_insert >= cost) {
                    value.classList.add("yellow");
                    console.log(money_insert+" "+cost);
                }
                else value.classList.remove("yellow");
            });          
        }
        */
    </script>
</head>
<body>
    <div class="container"><!--container 시작-->
        <div class="column_left"><!-- 왼쪽 div 시작-->
            <div class="item_panel">
                <ul>
                    <li><div>사이다</div><div><span>1</span>. <span>500</span></div></li>
                    <li><div>콜라</div><div><span>2</span>. <span>1000</span></div></li>
                    <li><div>환타파인</div><div><span>3</span>. <span>400</span></div></li>
                    <li><div>환타포도</div><div><span>4</span>. <span>300</span></div></li>
                    <li><div>레몬에이드</div><div><span>5</span>. <span>900</span></div></li>
                    <li><div>봉봉</div><div><span>6</span>. <span>1200</span></div></li>
                    <li><div>코코아주스</div><div><span>7</span>. <span>1000</span></div></li>
                    <li><div>콜라제로</div><div><span>8</span>. <span>1000</span></div></li>
                    <li><div>파워에이드</div><div><span>9</span>. <span>2000</span></div></li>
                    <li><div>초코우유</div><div><span>10</span>. <span>100</span></div></li>
                    <li><div>초코우유2</div><div><span>11</span>. <span>7000</span></div></li>
                    <li><div>초코우유3</div><div><span>12</span>. <span>600</span></div></li>
                    <li><div>딸바주스</div><div><span>13</span>. <span>1000</span></div></li>
                    <li><div>바나나우유</div><div><span>14</span>. <span>500</span></div></li>
                    <li><div>커피우유</div><div><span>15</span>. <span>1000</span></div></li>
                    <li><div>알로에</div><div><span>16</span>. <span>1200</span></div></li>
                    <li><div>콘칩</div><div><span>17</span>. <span>1000</span></div></li>
                    <li><div>새우깡</div><div><span>18</span>. <span>1000</span></div></li>
                    <li><div>감자칩</div><div><span>19</span>. <span>2000</span></div></li>
                    <li><div>칸쵸</div><div><span>20</span>. <span>1000</span></div></li>
                    <li><div>아몬드</div><div><span>21</span>. <span>450</span></div></li>
                    <li><div>다크초콜릿</div><div><span>22</span>. <span>1500</span></div></li>
                    <li><div>가나초콜릿</div><div><span>23</span>. <span>1200</span></div></li>
                    <li><div>견과류</div><div><span>24</span>. <span>900</span></div></li>
                    <li><div>육포</div><div><span>25</span>. <span>1000</span></div></li>
                    <li><div>오징어포</div><div><span>26</span>. <span>900</span></div></li>
                    <li><div>미니땅콩</div><div><span>27</span>. <span>4000</span></div></li>
                    <li><div>오징어</div><div><span>28</span>. <span>2300</span></div></li>
                    <li><div>{고장}</div><div><span>29</span>. <span>1000</span></div></li>
                    <li><div>신라면</div><div><span>30</span>. <span>700</span></div></li>
                    <li><div>진라면</div><div><span>31</span>. <span>800</span></div></li>
                    <li><div>환타포도</div><div><span>32</span>. <span>1000</span></div></li>
                </ul>
            </div>
            <div class="select_panel">
                <input type="text" class="money_insert" value="0";>
                <input type="text" class="button_clicked">
                <div class="select_button">
                    <button>1</button>
                    <button>2</button>
                    <button>3</button>
                    <button>4</button>
                    <button>5</button>
                    <button>6</button>
                    <button>7</button>
                    <button>8</button>
                    <button>9</button>
                    <button>0</button>
                </div>
                <div class="status"><textarea class="status_log" cols="30" rows="10"></textarea></div>
            </div>
        </div><!-- 왼쪽 div 끝-->

        <div class="column_right"> <!-- 오른쪽 div 시작-->
            <div class="money_panel">
                <div class="money_button">
                    <div data-value="10"><button>10원</button> <span data-value="0">0개</span></div>
                    <div data-value="50"><button>50원</button> <span data-value="0">0개</span></div>
                    <div data-value="100"><button>100원</button> <span data-value="0">0개</span></div>
                    <div data-value="500"><button>500원</button> <span data-value="0">0개</span></div>
                    <div data-value="1000"><button>1000원</button> <span data-value="0">0개</span></div>
                    <div data-value="5000"><button>5000원</button> <span data-value="0">0개</span></div>
                    <div data-value="10000"><button>10000원</button> <span data-value="0">0개</span></div>
                </div>
                <input type="text" class="money_have" data-value="22500" value="22500">
                <input type="button" class="refreshWallet" value="계산">
            </div>
            <script>
                //clickMoneyButton();
            </script>
        </div><!--오른쪽 div 끝-->
    </div><!--container 끝-->

</body>
</html>